<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MBTI èŒä¸šæ€§æ ¼æµ‹è¯•</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.2/echarts.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #0e0e11;
  --card: rgba(255,255,255,0.04);
  --card-border: rgba(255,255,255,0.07);
  --text: #f0f0f0;
  --text-2: rgba(255,255,255,0.55);
  --text-3: rgba(255,255,255,0.28);
  --glow1: rgba(120, 80, 220, 0.18);
  --glow2: rgba(60, 100, 240, 0.14);
  --glow3: rgba(200, 80, 160, 0.12);
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed; inset: 0;
  background:
    radial-gradient(ellipse 80% 60% at 15% 10%, var(--glow1) 0%, transparent 60%),
    radial-gradient(ellipse 60% 50% at 85% 20%, var(--glow2) 0%, transparent 55%),
    radial-gradient(ellipse 70% 55% at 50% 90%, var(--glow3) 0%, transparent 55%);
  pointer-events: none; z-index: 0;
}

body::after {
  content: '';
  position: fixed; top: -20%; left: -20%; width: 140%; height: 140%;
  background:
    radial-gradient(circle 400px at 20% 30%, rgba(140,80,255,0.06) 0%, transparent 100%),
    radial-gradient(circle 350px at 80% 70%, rgba(80,120,255,0.05) 0%, transparent 100%);
  animation: drift 20s ease-in-out infinite alternate;
  pointer-events: none; z-index: 0;
}

@keyframes drift {
  0% { transform: translate(0,0); }
  100% { transform: translate(-20px,15px); }
}

.wrap {
  max-width: 460px;
  margin: 0 auto;
  padding: 0 20px;
  position: relative;
  z-index: 1;
}

.page { display: none; }
.page.active { display: flex; flex-direction: column; }

/* ===== Buttons ===== */
.btn {
  display: block;
  width: 100%;
  max-width: 300px;
  margin: 0 auto;
  padding: 15px 0;
  border: none;
  border-radius: 50px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.btn-glow {
  background: rgba(255,255,255,0.1);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.18);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

.btn-glow:active { transform: scale(0.97); background: rgba(255,255,255,0.16); }

.btn-dim {
  background: rgba(255,255,255,0.06);
  color: var(--text-2);
  border: 1px solid rgba(255,255,255,0.08);
}

.btn-dim:active { background: rgba(255,255,255,0.1); }

/* ===== é¦–é¡µ ===== */
.home {
  min-height: 100dvh;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 40px 0;
}

.home-icon {
  width: 56px; height: 56px;
  border-radius: 16px;
  background: linear-gradient(135deg, rgba(120,80,220,0.35), rgba(80,100,240,0.25));
  border: 1px solid rgba(120,80,220,0.15);
  display: grid; place-items: center;
  margin: 0 auto 28px;
  font-size: 24px;
}

.home h1 {
  font-size: 24px;
  font-weight: 700;
  letter-spacing: -0.5px;
  margin-bottom: 8px;
}

.home .sub {
  font-size: 14px;
  color: var(--text-3);
  line-height: 1.7;
  margin-bottom: 40px;
}

.home-features {
  display: flex;
  gap: 20px;
  justify-content: center;
  margin-bottom: 40px;
}

.home-feat {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}

.home-feat-icon {
  width: 44px; height: 44px;
  border-radius: 12px;
  background: var(--card);
  border: 1px solid var(--card-border);
  display: grid; place-items: center;
  font-size: 18px;
}

.home-feat-text {
  font-size: 11px;
  color: var(--text-3);
  letter-spacing: 0.5px;
}

/* ===== ä¿¡æ¯é¡µ ===== */
.info-pg { padding: 56px 0 40px; }

.info-pg .hdr { margin-bottom: 32px; }
.info-pg .hdr h2 { font-size: 20px; font-weight: 600; margin-bottom: 6px; }
.info-pg .hdr p { font-size: 13px; color: var(--text-3); }

.fg { margin-bottom: 24px; }
.fg-label { font-size: 12px; font-weight: 500; color: var(--text-2); margin-bottom: 8px; letter-spacing: 0.3px; }

.g-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

.g-opt {
  padding: 13px;
  border: 1px solid var(--card-border);
  border-radius: 12px;
  background: var(--card);
  color: var(--text-2);
  font-size: 15px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.g-opt.on { border-color: rgba(255,255,255,0.25); background: rgba(255,255,255,0.07); color: var(--text); }

.inp {
  width: 100%; padding: 13px 16px;
  border: 1px solid var(--card-border); border-radius: 12px;
  background: var(--card); color: var(--text); font-size: 15px;
  outline: none; -webkit-appearance: none;
}

.inp::placeholder { color: var(--text-3); }
.inp:focus { border-color: rgba(255,255,255,0.18); }

.sel-w { position: relative; }
.sel-w::after {
  content: ''; position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
  border: 4px solid transparent; border-top: 5px solid var(--text-3); pointer-events: none;
}

.sel {
  width: 100%; padding: 13px 36px 13px 16px;
  border: 1px solid var(--card-border); border-radius: 12px;
  background: var(--card); color: var(--text); font-size: 15px;
  outline: none; -webkit-appearance: none; appearance: none;
}

.sel option { background: #1a1a1f; color: #eee; }
.sel:disabled { opacity: 0.3; }

.chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }

.chip {
  padding: 7px 14px; border: 1px solid var(--card-border); border-radius: 20px;
  background: transparent; color: var(--text-3); font-size: 13px; cursor: pointer; transition: all 0.2s;
}

.chip.on { border-color: rgba(255,255,255,0.25); background: rgba(255,255,255,0.07); color: var(--text-2); }

.sep {
  display: flex; align-items: center; gap: 10px; margin: 12px 0;
  font-size: 11px; color: var(--text-3); letter-spacing: 0.5px;
}

.sep::before, .sep::after { content: ''; flex: 1; height: 1px; background: var(--card-border); }

.f-err { font-size: 13px; color: #ff6b6b; margin-bottom: 10px; display: none; }

/* ===== ç­”é¢˜é¡µ ===== */
.quiz-pg {
  min-height: 100dvh;
  padding: 24px 0 32px;
  justify-content: space-between;
}

.prog-bar { margin-bottom: 4px; }

.prog-top {
  display: flex; justify-content: space-between; margin-bottom: 8px;
  font-size: 12px; color: var(--text-3); font-variant-numeric: tabular-nums;
}

.prog-track { height: 2px; background: rgba(255,255,255,0.06); border-radius: 1px; overflow: hidden; }
.prog-fill { height: 100%; background: #fff; border-radius: 1px; transition: width 0.4s ease; }

.q-body { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 20px 0; }

.q-card { animation: up 0.3s ease; }
@keyframes up { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }

.q-tag {
  display: inline-block; padding: 3px 8px; border-radius: 5px;
  background: rgba(255,255,255,0.06); font-size: 11px; color: var(--text-3);
  letter-spacing: 0.5px; margin-bottom: 14px;
}

.q-text {
  font-size: 19px; font-weight: 600; line-height: 1.6; margin-bottom: 28px;
}

.q-opt {
  display: block; width: 100%; padding: 16px 18px; margin-bottom: 10px;
  background: var(--card); border: 1px solid var(--card-border); border-radius: 14px;
  font-size: 15px; line-height: 1.5; color: var(--text-2); cursor: pointer;
  transition: all 0.15s; text-align: left;
}

.q-opt:active { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.18); color: var(--text); }

.q-skip {
  display: block; width: 100%; padding: 12px 18px; margin-bottom: 10px;
  background: none; border: 1px dashed rgba(255,255,255,0.08); border-radius: 14px;
  font-size: 13px; color: var(--text-3); cursor: pointer; transition: all 0.15s; text-align: center;
}

.q-skip:active { border-color: rgba(255,255,255,0.15); color: var(--text-2); }

.q-back {
  display: flex; align-items: center; justify-content: center; gap: 6px;
  margin: 18px auto 0; padding: 8px 20px;
  font-size: 13px; color: var(--text-3); background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.06); border-radius: 20px; cursor: pointer;
  transition: all 0.15s;
}

.q-back:active { background: rgba(255,255,255,0.08); color: var(--text-2); }

/* AI å‡ºé¢˜ loading */
.q-loading {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 40px 0; gap: 16px;
}

.q-loading-dots { display: flex; gap: 6px; }

.q-loading-dots span {
  width: 6px; height: 6px; border-radius: 50%; background: var(--text-3);
  animation: dotP 1.2s ease-in-out infinite;
}

.q-loading-dots span:nth-child(2) { animation-delay: 0.15s; }
.q-loading-dots span:nth-child(3) { animation-delay: 0.3s; }

@keyframes dotP { 0%,80%,100% { opacity:0.2; } 40% { opacity:0.8; } }

.q-loading-text { font-size: 13px; color: var(--text-3); }

/* ===== Loading é¡µ ===== */
.load-pg {
  min-height: 100dvh; justify-content: center; align-items: center; text-align: center;
}

.wave { display: flex; gap: 5px; margin-bottom: 20px; justify-content: center; }

.wave i {
  width: 3px; height: 22px; background: #fff; border-radius: 2px;
  animation: w 1.2s ease-in-out infinite; font-style: normal;
}

.wave i:nth-child(2){animation-delay:.1s} .wave i:nth-child(3){animation-delay:.2s}
.wave i:nth-child(4){animation-delay:.3s} .wave i:nth-child(5){animation-delay:.4s}

@keyframes w { 0%,100%{transform:scaleY(.4);opacity:.2} 50%{transform:scaleY(1);opacity:.7} }

.load-text { font-size: 14px; color: var(--text-3); }

/* ===== ç»“æœé¡µ ===== */
.res-pg { padding: 28px 0 48px; }

.res-hero { text-align: center; margin-bottom: 36px; animation: fu .6s ease; }

@keyframes fu { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

.res-tags { display: inline-flex; gap: 8px; margin-bottom: 18px; }
.res-tags span {
  padding: 4px 10px; border-radius: 6px; background: rgba(255,255,255,0.05);
  font-size: 11px; color: var(--text-3);
}

.res-type {
  font-size: 52px; font-weight: 800; letter-spacing: 6px; margin-bottom: 6px;
  background: linear-gradient(180deg, #fff 20%, rgba(255,255,255,0.25));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}

.res-name { font-size: 17px; color: var(--text-2); margin-bottom: 14px; }
.res-desc { font-size: 13px; color: var(--text-3); line-height: 1.8; max-width: 340px; margin: 0 auto; }

.radar-w { margin-bottom: 28px; animation: fu .6s ease .1s both; }
#radar { width: 100%; height: 260px; }

.sec { margin-bottom: 20px; animation: fu .5s ease both; }
.sec:nth-child(4){animation-delay:.12s} .sec:nth-child(5){animation-delay:.18s} .sec:nth-child(6){animation-delay:.24s}

.sec-card {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: 14px; padding: 20px;
}

.sec-label { font-size: 11px; color: var(--text-3); letter-spacing: 1.2px; margin-bottom: 14px; text-transform: uppercase; }

.dim-r { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
.dim-r:last-child { margin-bottom: 0; }
.dim-n { font-size: 12px; color: var(--text-2); width: 44px; text-align: right; flex-shrink: 0; }
.dim-t { flex: 1; height: 3px; background: rgba(255,255,255,0.06); border-radius: 2px; overflow: hidden; }
.dim-f { height: 100%; background: #fff; border-radius: 2px; transition: width 1s ease; }
.dim-p { font-size: 12px; color: var(--text-3); width: 32px; font-variant-numeric: tabular-nums; }

.ai-s { font-size: 14px; color: var(--text-2); line-height: 1.9; white-space: pre-wrap; word-wrap: break-word; }
.ai-s strong { color: var(--text); }

.blink::after { content:'|'; animation: bl 1s step-end infinite; color: var(--text-3); }
@keyframes bl { 50%{opacity:0} }

.ai-ld { display: flex; align-items: center; gap: 8px; padding: 12px 0; }
.ai-dot { width:5px;height:5px;border-radius:50%;background:var(--text-3);animation:dotP 1.4s ease-in-out infinite; }
.ai-dot:nth-child(2){animation-delay:.15s} .ai-dot:nth-child(3){animation-delay:.3s}
.ai-ld-t { font-size: 12px; color: var(--text-3); }

.ai-err { font-size: 13px; color: #ff6b6b; line-height: 1.6; }
.ai-err button { margin-top: 10px; padding: 7px 18px; border: 1px solid rgba(255,107,107,0.3); border-radius: 8px; background: none; color: #ff6b6b; font-size: 12px; cursor: pointer; }

.res-ft { margin-top: 12px; text-align: center; animation: fu .5s ease .4s both; }
</style>
</head>
<body>

<div class="wrap">
  <!-- é¦–é¡µ -->
  <div id="home" class="page home active">
    <div class="home-icon">M</div>
    <h1>MBTI èŒä¸šæ€§æ ¼æµ‹è¯•</h1>
    <p class="sub">AI å®æ—¶å‡ºé¢˜ Â· æ·±åº¦æ€§æ ¼åˆ†æ<br>ç²¾å‡†åŒ¹é…ä½ æ‰€åœ¨åŸå¸‚çš„èŒä¸šæ–¹å‘</p>
    <div class="home-features">
      <div class="home-feat">
        <div class="home-feat-icon">ğŸ§ </div>
        <div class="home-feat-text">AI å‡ºé¢˜</div>
      </div>
      <div class="home-feat">
        <div class="home-feat-icon">ğŸ“Š</div>
        <div class="home-feat-text">16 å‹äººæ ¼</div>
      </div>
      <div class="home-feat">
        <div class="home-feat-icon">ğŸ™</div>
        <div class="home-feat-text">åŸå¸‚å°±ä¸š</div>
      </div>
      <div class="home-feat">
        <div class="home-feat-icon">ğŸ¢</div>
        <div class="home-feat-text">ä¼ä¸šæ¨è</div>
      </div>
    </div>
    <button class="btn btn-glow" onclick="showPage('info')">å¼€å§‹æµ‹è¯•</button>
  </div>

  <!-- ä¿¡æ¯é¡µ -->
  <div id="info" class="page info-pg">
    <div class="hdr">
      <h2>åŸºæœ¬ä¿¡æ¯</h2>
      <p>å¸®åŠ© AI ç”Ÿæˆä¸ªæ€§åŒ–çš„æµ‹è¯•é¢˜ç›®</p>
    </div>

    <div class="fg">
      <div class="fg-label">æ€§åˆ«</div>
      <div class="g-row">
        <div class="g-opt" onclick="pickG(this,'ç”·')">ç”·</div>
        <div class="g-opt" onclick="pickG(this,'å¥³')">å¥³</div>
      </div>
    </div>

    <div class="fg">
      <div class="fg-label">å¹´é¾„</div>
      <input class="inp" id="ageInp" type="number" placeholder="è¾“å…¥ä½ çš„å¹´é¾„" min="10" max="100" inputmode="numeric">
    </div>

    <div class="fg">
      <div class="fg-label">æ‰€åœ¨åŸå¸‚</div>
      <div class="chips" id="hotGrid"></div>
      <div class="sep"><span>æˆ–é€‰æ‹©çœä»½</span></div>
      <div class="g-row">
        <div class="sel-w"><select class="sel" id="provS" onchange="onProv()"><option value="">çœä»½</option></select></div>
        <div class="sel-w"><select class="sel" id="cityS" disabled><option value="">åŸå¸‚</option></select></div>
      </div>
    </div>

    <div id="fErr" class="f-err"></div>
    <button class="btn btn-glow" onclick="goQuiz()">å¼€å§‹ç­”é¢˜</button>
  </div>

  <!-- ç­”é¢˜é¡µ -->
  <div id="quiz" class="page quiz-pg">
    <div class="prog-bar">
      <div class="prog-top"><span id="pN">1 / 20</span><span id="pP">0%</span></div>
      <div class="prog-track"><div class="prog-fill" id="pF"></div></div>
    </div>
    <div class="q-body" id="qBody"></div>
  </div>

  <!-- Loading -->
  <div id="loading" class="page load-pg">
    <div>
      <div class="wave"><i></i><i></i><i></i><i></i><i></i></div>
      <div class="load-text">æ­£åœ¨åˆ†æä½ çš„äººæ ¼ç‰¹è´¨...</div>
    </div>
  </div>

  <!-- ç»“æœé¡µ -->
  <div id="result" class="page res-pg"></div>
</div>

<script>
const API_KEY = 'sk-Onn9SamRwvkNDIeJvmAgQLH1xxwnphibz9F520aEfY5VrC0o';
const API_BASE = 'https://www.packyapi.com';
const TOTAL_Q = 20;

const provData = {
  "åŒ—äº¬å¸‚":["åŒ—äº¬"],"ä¸Šæµ·å¸‚":["ä¸Šæµ·"],"å¤©æ´¥å¸‚":["å¤©æ´¥"],"é‡åº†å¸‚":["é‡åº†"],
  "å¹¿ä¸œçœ":["å¹¿å·","æ·±åœ³","ä¸œè","ä½›å±±","ç æµ·","æƒ å·","ä¸­å±±","æ±•å¤´"],
  "æ±Ÿè‹çœ":["å—äº¬","è‹å·","æ— é”¡","å¸¸å·","å—é€š","å¾å·","æ‰¬å·"],
  "æµ™æ±Ÿçœ":["æ­å·","å®æ³¢","æ¸©å·","ç»å…´","å˜‰å…´","é‡‘å","å°å·"],
  "å±±ä¸œçœ":["æµå—","é’å²›","çƒŸå°","æ½åŠ","ä¸´æ²‚","å¨æµ·"],
  "æ²³å—çœ":["éƒ‘å·","æ´›é˜³","å—é˜³","è®¸æ˜Œ","æ–°ä¹¡","å¼€å°"],
  "å››å·çœ":["æˆéƒ½","ç»µé˜³","å¾·é˜³","å®œå®¾","å—å……","æ³¸å·"],
  "æ¹–åŒ—çœ":["æ­¦æ±‰","å®œæ˜Œ","è¥„é˜³","è†å·","åå °"],
  "æ¹–å—çœ":["é•¿æ²™","æ ªæ´²","æ¹˜æ½­","è¡¡é˜³","å²³é˜³"],
  "ç¦å»ºçœ":["ç¦å·","å¦é—¨","æ³‰å·","æ¼³å·","è†ç”°"],
  "å®‰å¾½çœ":["åˆè‚¥","èŠœæ¹–","èšŒåŸ ","é˜œé˜³","å®‰åº†"],
  "æ²³åŒ—çœ":["çŸ³å®¶åº„","å”å±±","ä¿å®š","é‚¯éƒ¸","å»ŠåŠ"],
  "è¾½å®çœ":["æ²ˆé˜³","å¤§è¿","éå±±","é”¦å·"],
  "é™•è¥¿çœ":["è¥¿å®‰","å’¸é˜³","å®é¸¡","æ¸­å—"],
  "æ±Ÿè¥¿çœ":["å—æ˜Œ","èµ£å·","ä¹æ±Ÿ","å®œæ˜¥"],
  "é»‘é¾™æ±Ÿçœ":["å“ˆå°”æ»¨","å¤§åº†","é½é½å“ˆå°”"],
  "å‰æ—çœ":["é•¿æ˜¥","å‰æ—","å››å¹³"],
  "å±±è¥¿çœ":["å¤ªåŸ","å¤§åŒ","è¿åŸ"],
  "äº‘å—çœ":["æ˜†æ˜","æ›²é–","å¤§ç†","ä¸½æ±Ÿ"],
  "å¹¿è¥¿å£®æ—è‡ªæ²»åŒº":["å—å®","æŸ³å·","æ¡‚æ—","åŒ—æµ·"],
  "è´µå·çœ":["è´µé˜³","éµä¹‰"],
  "ç”˜è‚ƒçœ":["å…°å·","å¤©æ°´"],
  "æµ·å—çœ":["æµ·å£","ä¸‰äºš"],
  "å†…è’™å¤è‡ªæ²»åŒº":["å‘¼å’Œæµ©ç‰¹","åŒ…å¤´","é„‚å°”å¤šæ–¯"],
  "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº":["ä¹Œé²æœ¨é½","æ˜Œå‰"],
  "å®å¤å›æ—è‡ªæ²»åŒº":["é“¶å·"],"é’æµ·çœ":["è¥¿å®"],"è¥¿è—è‡ªæ²»åŒº":["æ‹‰è¨"],
  "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº":["é¦™æ¸¯"],"æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº":["æ¾³é—¨"],"å°æ¹¾çœ":["å°åŒ—","é«˜é›„","å°ä¸­"]
};

const hot = ["åŒ—äº¬","ä¸Šæµ·","å¹¿å·","æ·±åœ³","æ­å·","æˆéƒ½","æ­¦æ±‰","å—äº¬","é‡åº†","è¥¿å®‰","é•¿æ²™","è‹å·"];

const dimMap = { EI:"å¤–å‘E/å†…å‘I", SN:"æ„Ÿè§‰S/ç›´è§‰N", TF:"æ€ç»´T/æƒ…æ„ŸF", JP:"åˆ¤æ–­J/çŸ¥è§‰P" };

const typeData = {
  ISTJ:{n:"æ£€æŸ¥è€…",d:"åŠ¡å®å¯é ï¼Œæ³¨é‡äº‹å®å’Œè´£ä»»ï¼Œåšäº‹æœ‰æ¡ä¸ç´Šã€‚"},
  ISFJ:{n:"å®ˆæŠ¤è€…",d:"å‹å–„è´Ÿè´£ï¼Œæ³¨é‡ç»†èŠ‚å’Œä»–äººæ„Ÿå—ï¼Œç¨³å®šå¯é ã€‚"},
  INFJ:{n:"æå€¡è€…",d:"æœ‰è¿œè§å’Œæ´å¯ŸåŠ›ï¼Œåšå®šæ‰§è¡Œè‡ªå·±çš„æ„¿æ™¯ã€‚"},
  INTJ:{n:"å»ºç­‘å¸ˆ",d:"æˆ˜ç•¥æ€ç»´ï¼Œå–„äºé•¿è¿œè§„åˆ’å¹¶åšå®šæ‰§è¡Œã€‚"},
  ISTP:{n:"é‰´èµå®¶",d:"çµæ´»åŠ¡å®ï¼Œå–„äºåˆ†æé—®é¢˜å¹¶è¿…é€Ÿæ‰¾åˆ°è§£å†³æ–¹æ¡ˆã€‚"},
  ISFP:{n:"æ¢é™©å®¶",d:"å‹å¥½æ•æ„Ÿï¼Œäº«å—å½“ä¸‹ï¼Œå¿ äºè‡ªå·±çš„ä»·å€¼è§‚ã€‚"},
  INFP:{n:"è°ƒåœè€…",d:"ç†æƒ³ä¸»ä¹‰è€…ï¼Œå¥½å¥‡å¿ƒå¼ºï¼Œå¯»æ±‚ç†è§£å’Œå¸®åŠ©ä»–äººã€‚"},
  INTP:{n:"é€»è¾‘å­¦å®¶",d:"è¿½æ±‚åˆç†è§£é‡Šï¼Œå–œæ¬¢ç†è®ºå’ŒæŠ½è±¡æ€è€ƒã€‚"},
  ESTP:{n:"ä¼ä¸šå®¶",d:"çµæ´»åŠ¡å®ï¼Œå–„äºå¿«é€Ÿè¯„ä¼°å¹¶é‡‡å–è¡ŒåŠ¨ã€‚"},
  ESFP:{n:"è¡¨æ¼”è€…",d:"å¤–å‘å‹å–„ï¼Œçƒ­çˆ±ç”Ÿæ´»ï¼Œå¸¦æ¥ä¹è¶£å’Œæ´»åŠ›ã€‚"},
  ENFP:{n:"ç«é€‰è€…",d:"çƒ­æƒ…æœ‰æƒ³è±¡åŠ›ï¼Œå……æ»¡è‡ªä¿¡åœ°å³å…´å‘æŒ¥ã€‚"},
  ENTP:{n:"è¾©è®ºå®¶",d:"èªæ˜æ•æ·ï¼Œå–„äºåˆ›æ–°è§£å†³é—®é¢˜ã€‚"},
  ESTJ:{n:"æ€»ç»ç†",d:"æœæ–­åŠ¡å®ï¼Œå–„äºç»„ç»‡å¹¶æ³¨é‡æ•ˆç‡ã€‚"},
  ESFJ:{n:"æ‰§æ”¿å®˜",d:"çƒ­å¿ƒåˆä½œï¼Œé‡è§†å’Œè°ï¼Œå¿ è¯šå¯é ã€‚"},
  ENFJ:{n:"ä¸»äººå…¬",d:"å¯Œæœ‰åŒç†å¿ƒï¼Œå–„äºæ¿€åŠ±å’Œå¼•å¯¼ä»–äººæˆé•¿ã€‚"},
  ENTJ:{n:"æŒ‡æŒ¥å®˜",d:"æœæ–­é¢†å¯¼ï¼Œå–„äºåˆ¶å®šç³»ç»Ÿè§£å†³ç»„ç»‡é—®é¢˜ã€‚"}
};

// State
let cur = 0, qList = [], ansList = [];
let user = { gender:'', age:'', city:'' };
let scores = { E:0,I:0,S:0,N:0,T:0,F:0,J:0,P:0 };
let prefetchedQ = null;   // é¢„åŠ è½½çš„ä¸‹ä¸€é¢˜æ•°æ®
let prefetchPromise = null; // é¢„åŠ è½½è¯·æ±‚çš„ Promise

// éŸ³æ•ˆ
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx;
function playTick() {
  if (!audioCtx) audioCtx = new AudioCtx();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.frequency.value = 880;
  o.type = 'sine';
  g.gain.setValueAtTime(0.15, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.08);
  o.start(); o.stop(audioCtx.currentTime + 0.08);
}

// Init
function init() {
  const g = document.getElementById('hotGrid');
  hot.forEach(c => { const s = document.createElement('span'); s.className='chip'; s.textContent=c; s.onclick=()=>pickC(s,c); g.appendChild(s); });
  const ps = document.getElementById('provS');
  Object.keys(provData).forEach(p => { const o = document.createElement('option'); o.value=p; o.textContent=p; ps.appendChild(o); });
}

function pickG(el,g) { document.querySelectorAll('.g-opt').forEach(e=>e.classList.remove('on')); el.classList.add('on'); user.gender=g; }

function pickC(el,c) { document.querySelectorAll('.chip').forEach(e=>e.classList.remove('on')); el.classList.add('on'); user.city=c; document.getElementById('provS').value=''; document.getElementById('cityS').value=''; document.getElementById('cityS').disabled=true; }

function onProv() {
  const p=document.getElementById('provS').value, cs=document.getElementById('cityS');
  cs.innerHTML='<option value="">åŸå¸‚</option>';
  if(p&&provData[p]){provData[p].forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;cs.appendChild(o)});cs.disabled=false;cs.onchange=function(){if(this.value){user.city=this.value;document.querySelectorAll('.chip').forEach(e=>e.classList.remove('on'))}}}else{cs.disabled=true}
}

function goQuiz() {
  user.age=document.getElementById('ageInp').value;
  const cv=document.getElementById('cityS').value; if(cv)user.city=cv;
  const e=document.getElementById('fErr');
  if(!user.gender||!user.age||!user.city){e.textContent='è¯·å®Œå–„æ‰€æœ‰ä¿¡æ¯';e.style.display='block';return}
  if(user.age<10||user.age>100){e.textContent='è¯·è¾“å…¥æœ‰æ•ˆå¹´é¾„';e.style.display='block';return}
  e.style.display='none';
  cur=0; qList=[]; ansList=[]; scores={E:0,I:0,S:0,N:0,T:0,F:0,J:0,P:0};
  prefetchedQ=null; prefetchPromise=null;
  showPage('quiz');
  genQuestion();
}

function showPage(id) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo({top:0}); }

// ===== AI å‡ºé¢˜ =====
const dimOrder = ['EI','EI','EI','EI','EI','SN','SN','SN','SN','SN','TF','TF','TF','TF','TF','JP','JP','JP','JP','JP'];

// ç‹¬ç«‹çš„ API è¯·æ±‚å‡½æ•°ï¼Œæ¥å—é¢˜å·å‚æ•°ï¼Œè¿”å› Promise<question>
function fetchQuestion(qIndex) {
  const dim = dimOrder[qIndex];

  // æ„å»ºä¸Šä¸‹æ–‡
  let history = '';
  if (qList.length > 0) {
    const last3 = qList.slice(-3).map((q,i) => {
      const idx = qList.length - 3 + i;
      if (idx < 0) return '';
      return 'é¢˜: ' + q.q + ' â†’ ç”¨æˆ·é€‰: ' + (ansList[idx]==='a' ? q.a : q.b);
    }).filter(Boolean).join('\n');
    history = '\n\næœ€è¿‘å›ç­”:\n' + last3;
  }

  const dimFullName = {EI:'å¤–å‘(E)/å†…å‘(I)',SN:'æ„Ÿè§‰(S)/ç›´è§‰(N)',TF:'æ€ç»´(T)/æƒ…æ„Ÿ(F)',JP:'åˆ¤æ–­(J)/çŸ¥è§‰(P)'}[dim];

  // è®¡ç®—å½“å‰ç»´åº¦å€¾å‘
  let tilt = '';
  if (qIndex > 0) {
    const d0 = dim[0], d1 = dim[1];
    const diff = scores[d0] - scores[d1];
    if (diff > 1) tilt = `\nç”¨æˆ·ç›®å‰æ˜æ˜¾å${d0}ï¼Œè¯·å‡ºæ›´ç»†è…»çš„è¾¹ç•Œé¢˜æ¥ç²¾ç¡®æ¢æµ‹ã€‚`;
    else if (diff < -1) tilt = `\nç”¨æˆ·ç›®å‰æ˜æ˜¾å${d1}ï¼Œè¯·å‡ºæ›´ç»†è…»çš„è¾¹ç•Œé¢˜æ¥ç²¾ç¡®æ¢æµ‹ã€‚`;
  }

  const prompt = `ä½ æ˜¯èµ„æ·± MBTI å¿ƒç†æµ‹è¯„å¸ˆï¼Œç²¾é€šè£æ ¼äººæ ¼ç±»å‹ç†è®ºã€‚ä¸ºä»¥ä¸‹ç”¨æˆ·å‡º 1 é“æµ‹è¯•é¢˜ã€‚

ç”¨æˆ·: ${user.gender}ï¼Œ${user.age}å²ï¼Œ${user.city}
ç¬¬ ${qIndex+1}/${TOTAL_Q} é¢˜ï¼Œæµ‹è¯•ç»´åº¦: ${dimFullName}${tilt}
${history}

å‡ºé¢˜åŸåˆ™:
1. ç”¨çœŸå®ç”Ÿæ´»åœºæ™¯å‡ºé¢˜ï¼ˆå·¥ä½œã€ç¤¾äº¤ã€ä¼‘é—²ã€å†³ç­–ç­‰ï¼‰ï¼Œä¸è¦æŠ½è±¡æè¿°
2. ä¸¤ä¸ªé€‰é¡¹å¿…é¡»åŒæ ·æœ‰å¸å¼•åŠ›ï¼Œä¸èƒ½æœ‰æ˜æ˜¾"æ›´å¥½"çš„ç­”æ¡ˆ
3. ç”¨å£è¯­åŒ–è¡¨è¾¾ï¼Œåƒæœ‹å‹åœ¨èŠå¤©ï¼Œä¸è¦å¿ƒç†å­¦æœ¯è¯­
4. é¢˜ç›®è¦æœ‰å…·ä½“ç»†èŠ‚ï¼ˆå¦‚"å‘¨æœ«ä¸‹åˆ""åŒäº‹çº¦ä½ ""åˆšåˆ°ä¸€ä¸ªæ–°åŸå¸‚"ï¼‰ï¼Œä¸è¦æ³›æ³›è€Œè°ˆ
5. é€‰é¡¹Aå¯¹åº”${dim[0]}å€¾å‘ï¼Œé€‰é¡¹Bå¯¹åº”${dim[1]}å€¾å‘
6. ä¸ä¹‹å‰çš„é¢˜ç›®åœºæ™¯ä¸åŒï¼Œè¦†ç›–ä¸åŒç”Ÿæ´»é¢
7. é¢˜ç›®ä¸è¶…è¿‡40å­—ï¼Œæ¯ä¸ªé€‰é¡¹ä¸è¶…è¿‡30å­—ï¼ŒåŠ¡å¿…ç²¾ç®€

ä¸¥æ ¼æŒ‰æ­¤ JSON è¾“å‡ºï¼Œä¸è¦ä»»ä½•å…¶ä»–å†…å®¹:
{"q":"é¢˜ç›®","a":"é€‰é¡¹A","b":"é€‰é¡¹B"}`;

  return fetch(API_BASE + '/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'x-api-key':API_KEY, 'anthropic-version':'2023-06-01', 'anthropic-dangerous-direct-browser-access':'true' },
    body: JSON.stringify({ model:'claude-sonnet-4-20250514', max_tokens:400, messages:[{role:'user',content:prompt}] })
  }).then(resp => {
    if (!resp.ok) throw new Error('API ' + resp.status);
    return resp.json();
  }).then(data => {
    const textBlock = data.content.find(b => b.type === 'text');
    if (!textBlock || !textBlock.text) throw new Error('æ— æ–‡æœ¬è¿”å›');
    const text = textBlock.text.trim();
    console.log('AI è¿”å›:', text);

    const start = text.indexOf('{');
    const end = text.lastIndexOf('}');
    if (start === -1 || end === -1 || end <= start) throw new Error('æ ¼å¼é”™è¯¯');

    let q;
    try { q = JSON.parse(text.slice(start, end + 1)); } catch(pe) {
      console.error('JSONè§£æå¤±è´¥:', text.slice(start, end + 1));
      throw new Error('JSONè§£æå¤±è´¥');
    }
    if (!q.q || !q.a || !q.b) throw new Error('ç¼ºå°‘å­—æ®µ');
    q.d = dim;
    return q;
  });
}

// æ¸²æŸ“é¢˜ç›®åˆ°é¡µé¢
function renderQuestion(q) {
  const body = document.getElementById('qBody');
  body.innerHTML = '';
  const card = document.createElement('div');
  card.className = 'q-card';
  card.innerHTML =
    '<div class="q-tag">' + dimMap[q.d] + '</div>' +
    '<div class="q-text">' + q.q + '</div>' +
    '<button class="q-opt" data-c="a">' + q.a + '</button>' +
    '<button class="q-opt" data-c="b">' + q.b + '</button>' +
    '<button class="q-skip">ä¸å¤ªç¡®å®šï¼Œè·³è¿‡</button>' +
    (cur > 0 ? '<button class="q-back" onclick="prevQ()">è¿”å›ä¸Šä¸€é¢˜</button>' : '');
  body.appendChild(card);
  card.querySelectorAll('.q-opt').forEach(b => b.addEventListener('click', function(){ pickAns(this.dataset.c); }));
  card.querySelector('.q-skip').addEventListener('click', function(){ pickAns('skip'); });
}

// å¯åŠ¨é¢„åŠ è½½ä¸‹ä¸€é¢˜
function startPrefetch() {
  if (cur + 1 < TOTAL_Q) {
    prefetchPromise = fetchQuestion(cur + 1);
    prefetchPromise.then(q => { prefetchedQ = q; }).catch(err => {
      console.warn('é¢„åŠ è½½å¤±è´¥ï¼ˆä¸å½±å“ä½“éªŒï¼‰:', err);
      prefetchedQ = null;
      prefetchPromise = null;
    });
  }
}

async function genQuestion() {
  const body = document.getElementById('qBody');
  const pct = Math.round(cur/TOTAL_Q*100);
  document.getElementById('pN').textContent = (cur+1)+' / '+TOTAL_Q;
  document.getElementById('pP').textContent = pct+'%';
  document.getElementById('pF').style.width = pct+'%';

  try {
    let q;

    if (prefetchedQ) {
      // é¢„åŠ è½½å·²å®Œæˆï¼Œç§’æ¸²æŸ“
      q = prefetchedQ;
      prefetchedQ = null;
      prefetchPromise = null;
    } else if (prefetchPromise) {
      // é¢„åŠ è½½è¿›è¡Œä¸­ï¼Œæ˜¾ç¤º loading å¹¶ç­‰å¾…
      const loadTips = [
        `æ­£åœ¨æ ¹æ®${user.age}å²${user.gender}æ€§çš„ç”Ÿæ´»åœºæ™¯å®šåˆ¶é¢˜ç›®...`,
        `æ­£åœ¨ç»“åˆ${user.city}çš„ç”Ÿæ´»èƒŒæ™¯ä¸ºä½ å‡ºé¢˜...`,
        `æ­£åœ¨åˆ†æä½ çš„å›ç­”å€¾å‘ï¼Œç”Ÿæˆæ›´ç²¾å‡†çš„é—®é¢˜...`,
        `æ­£åœ¨ä¸ºä½ é‡èº«è®¾è®¡ä¸‹ä¸€é“æƒ…å¢ƒé¢˜...`,
        `æ ¹æ®ä½ çš„ä½œç­”é£æ ¼ï¼Œæ­£åœ¨åŒ¹é…æœ€ä½³æµ‹è¯•è·¯å¾„...`,
        `æ­£åœ¨ç»“åˆä½ çš„ä¸ªäººç‰¹å¾å®šåˆ¶ä¸“å±é¢˜ç›®...`
      ];
      const tip = cur < 2 ? loadTips[cur] : loadTips[Math.floor(Math.random() * (loadTips.length - 2)) + 2];
      body.innerHTML = '<div class="q-loading"><div class="q-loading-dots"><span></span><span></span><span></span></div><div class="q-loading-text">' + tip + '</div></div>';
      q = await prefetchPromise;
      prefetchedQ = null;
      prefetchPromise = null;
    } else {
      // æ— é¢„åŠ è½½ï¼ˆé¦–é¢˜æˆ–é¢„åŠ è½½å¤±è´¥ï¼‰ï¼Œæ­£å¸¸è¯·æ±‚
      const loadTips = [
        `æ­£åœ¨æ ¹æ®${user.age}å²${user.gender}æ€§çš„ç”Ÿæ´»åœºæ™¯å®šåˆ¶é¢˜ç›®...`,
        `æ­£åœ¨ç»“åˆ${user.city}çš„ç”Ÿæ´»èƒŒæ™¯ä¸ºä½ å‡ºé¢˜...`,
        `æ­£åœ¨åˆ†æä½ çš„å›ç­”å€¾å‘ï¼Œç”Ÿæˆæ›´ç²¾å‡†çš„é—®é¢˜...`,
        `æ­£åœ¨ä¸ºä½ é‡èº«è®¾è®¡ä¸‹ä¸€é“æƒ…å¢ƒé¢˜...`,
        `æ ¹æ®ä½ çš„ä½œç­”é£æ ¼ï¼Œæ­£åœ¨åŒ¹é…æœ€ä½³æµ‹è¯•è·¯å¾„...`,
        `æ­£åœ¨ç»“åˆä½ çš„ä¸ªäººç‰¹å¾å®šåˆ¶ä¸“å±é¢˜ç›®...`
      ];
      const tip = cur < 2 ? loadTips[cur] : loadTips[Math.floor(Math.random() * (loadTips.length - 2)) + 2];
      body.innerHTML = '<div class="q-loading"><div class="q-loading-dots"><span></span><span></span><span></span></div><div class="q-loading-text">' + tip + '</div></div>';
      q = await fetchQuestion(cur);
    }

    qList[cur] = q;
    renderQuestion(q);

    // æ¸²æŸ“å®Œæˆåï¼Œå¯åŠ¨é¢„åŠ è½½ä¸‹ä¸€é¢˜
    startPrefetch();

  } catch(err) {
    console.error(err);
    prefetchedQ = null;
    prefetchPromise = null;
    body.innerHTML = '<div class="q-loading"><div class="q-loading-text" style="color:#ff6b6b">å‡ºé¢˜å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•</div><button class="btn btn-dim" style="max-width:160px;margin-top:12px" onclick="genQuestion()">é‡è¯•</button></div>';
  }
}

function pickAns(c) {
  playTick();
  ansList[cur] = c;
  const q = qList[cur];
  if (c === 'a') scores[q.d[0]]++;
  else if (c === 'b') scores[q.d[1]]++;
  else { scores[q.d[0]] += 0.5; scores[q.d[1]] += 0.5; }
  cur++;
  if (cur >= TOTAL_Q) { prefetchedQ=null; prefetchPromise=null; goResult(); } else { genQuestion(); }
}

function prevQ() {
  if (cur > 0) {
    // æ¸…ç©ºé¢„åŠ è½½ï¼ˆå›é€€åé¢˜åºå˜äº†ï¼‰
    prefetchedQ = null;
    prefetchPromise = null;

    const lastQ = qList[cur-1];
    const lastAns = ansList[cur-1];
    if (lastAns === 'a') scores[lastQ.d[0]]--;
    else if (lastAns === 'b') scores[lastQ.d[1]]--;
    else { scores[lastQ.d[0]] -= 0.5; scores[lastQ.d[1]] -= 0.5; }
    cur--;

    const pct = Math.round(cur/TOTAL_Q*100);
    document.getElementById('pN').textContent = (cur+1)+' / '+TOTAL_Q;
    document.getElementById('pP').textContent = pct+'%';
    document.getElementById('pF').style.width = pct+'%';

    renderQuestion(qList[cur]);

    // å›é€€åé‡æ–°é¢„åŠ è½½ä¸‹ä¸€é¢˜
    startPrefetch();
  }
}

// ===== ç»“æœ =====
function goResult() {
  showPage('loading');
  setTimeout(() => {
    const sc = scores;
    const type = (sc.E>=sc.I?'E':'I')+(sc.S>=sc.N?'S':'N')+(sc.T>=sc.F?'T':'F')+(sc.J>=sc.P?'J':'P');
    const td = typeData[type];

    const dims = [
      {n:'å¤–å‘E',v:sc.E,t:sc.E+sc.I},{n:'æ„Ÿè§‰S',v:sc.S,t:sc.S+sc.N},
      {n:'æ€ç»´T',v:sc.T,t:sc.T+sc.F},{n:'åˆ¤æ–­J',v:sc.J,t:sc.J+sc.P}
    ];

    let dH = '';
    dims.forEach(d => { const p=Math.round(d.v/d.t*100); dH+='<div class="dim-r"><div class="dim-n">'+d.n+'</div><div class="dim-t"><div class="dim-f" style="width:'+p+'%"></div></div><div class="dim-p">'+p+'%</div></div>'; });

    const rd = [Math.round(sc.E/(sc.E+sc.I)*100),Math.round(sc.S/(sc.S+sc.N)*100),Math.round(sc.T/(sc.T+sc.F)*100),Math.round(sc.J/(sc.J+sc.P)*100),Math.round(sc.N/(sc.S+sc.N)*100),Math.round(sc.F/(sc.T+sc.F)*100)];

    const el = document.getElementById('result');
    el.innerHTML =
      '<div class="res-hero"><div class="res-tags"><span>'+user.gender+'</span><span>'+user.age+'å²</span><span>'+user.city+'</span></div><div class="res-type">'+type+'</div><div class="res-name">'+td.n+'</div><div class="res-desc">'+td.d+'</div></div>' +
      '<div class="radar-w"><div id="radar"></div></div>' +
      '<div class="sec"><div class="sec-card"><div class="sec-label">ç»´åº¦åˆ†æ</div>'+dH+'</div></div>' +
      '<div class="sec" id="as1"><div class="sec-card"><div class="sec-label">AI èŒä¸šåˆ†æ</div><div id="ab1"><div class="ai-ld"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-ld-t">åˆ†æä¸­...</div></div></div></div></div>' +
      '<div class="sec" id="as2"><div class="sec-card"><div class="sec-label">'+user.city+' æ¨èä¼ä¸š</div><div id="ab2"><div class="ai-ld"><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-ld-t">æœç´¢ä¸­...</div></div></div></div></div>' +
      '<div class="res-ft"><button class="btn btn-dim" onclick="showPage(\'home\')">é‡æ–°æµ‹è¯•</button></div>';

    showPage('result');

    const ch = echarts.init(document.getElementById('radar'));
    ch.setOption({
      radar:{
        indicator:[{name:'å¤–å‘',max:100},{name:'æ„Ÿè§‰',max:100},{name:'æ€ç»´',max:100},{name:'åˆ¤æ–­',max:100},{name:'ç›´è§‰',max:100},{name:'æƒ…æ„Ÿ',max:100}],
        shape:'circle',splitNumber:4,
        axisName:{color:'rgba(255,255,255,0.3)',fontSize:11},
        splitArea:{areaStyle:{color:['rgba(255,255,255,0.02)','rgba(255,255,255,0.04)']}},
        axisLine:{lineStyle:{color:'rgba(255,255,255,0.06)'}},
        splitLine:{lineStyle:{color:'rgba(255,255,255,0.05)'}}
      },
      series:[{type:'radar',data:[{value:rd,areaStyle:{color:'rgba(120,80,220,0.15)'},lineStyle:{color:'rgba(160,130,255,0.5)',width:1.5},itemStyle:{color:'rgba(160,130,255,0.8)'},symbol:'circle',symbolSize:4}]}]
    });

    aiCareer(type,td.n,sc);
    aiSearch(type,td.n);
  }, 1200);
}

// ===== AI èŒä¸šåˆ†æï¼ˆç²¾ç®€ï¼‰ =====
async function aiCareer(type,name,sc) {
  const box = document.getElementById('ab1');
  const prompt = `ç”¨æˆ·ï¼š${user.gender}ï¼Œ${user.age}å²ï¼Œ${user.city}ï¼ŒMBTI ${type}ï¼ˆ${name}ï¼‰
E${sc.E}/I${sc.I} S${sc.S}/N${sc.N} T${sc.T}/F${sc.F} J${sc.J}/P${sc.P}

è¯·ç”¨æç®€é£æ ¼è¾“å‡ºï¼ˆæ€»è®¡ä¸è¶…è¿‡ 250 å­—ï¼‰ï¼š
**æ€§æ ¼ä¼˜åŠ¿**ï¼š2å¥è¯æ¦‚æ‹¬æ ¸å¿ƒä¼˜åŠ¿
**${user.city}æœºä¼š**ï¼š2å¥è¯ç‚¹æ˜é€‚åˆçš„è¡Œä¸šæ–¹å‘
**æ¨èèŒä¸š**ï¼šåˆ—å‡º4ä¸ªï¼Œæ¯ä¸ªä»…"èŒä¸šå â€” ä¸€å¥è¯ç†ç”±"
**ä¸€æ¡å»ºè®®**ï¼šé’ˆå¯¹${user.age}å²ç»™1æ¡æœ€å…³é”®çš„å»ºè®®

ç›´æ¥è¾“å‡ºï¼Œä¸è¦å¯’æš„ã€‚`;

  await streamCall(box, prompt, false);
}

// ===== AI æœç´¢ä¼ä¸šï¼ˆç²¾ç®€ï¼‰ =====
async function aiSearch(type,name) {
  const box = document.getElementById('ab2');
  const prompt = `æœç´¢${user.city}é€‚åˆ MBTI ${type}ï¼ˆ${name}ï¼‰çš„çŸ¥åä¼ä¸šã€‚

è¾“å‡º 5 å®¶ä¼ä¸šï¼Œæ¯å®¶ä¸€è¡Œï¼Œæ ¼å¼ï¼š
**ä¼ä¸šå** â€” è¡Œä¸š â€” ä¸ºä»€ä¹ˆé€‚åˆï¼ˆ10å­—å†…ï¼‰

ä¸è¦å¯’æš„ï¼Œä¸è¦å¤šä½™è§£é‡Šï¼Œæ€»è®¡ä¸è¶…è¿‡ 150 å­—ã€‚`;

  await streamCall(box, prompt, true);
}

// ===== æµå¼è°ƒç”¨ =====
async function streamCall(box, prompt, search) {
  try {
    const b = { model:'claude-sonnet-4-20250514', max_tokens:600, stream:true, messages:[{role:'user',content:prompt}] };
    if (search) b.tools = [{type:'web_search_20250305',name:'web_search',max_uses:3}];

    const r = await fetch(API_BASE+'/v1/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':API_KEY,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify(b)
    });

    if (!r.ok) throw new Error(r.status);

    const rd = r.body.getReader(), dc = new TextDecoder();
    let txt='', buf='';
    box.innerHTML = '<div class="ai-s blink"></div>';
    const el = box.querySelector('.ai-s');

    while(true) {
      const {done,value} = await rd.read();
      if(done) break;
      buf += dc.decode(value,{stream:true});
      const ls = buf.split('\n'); buf = ls.pop()||'';
      for(const l of ls) {
        if(!l.startsWith('data: ')) continue;
        const d = l.slice(6).trim();
        if(d==='[DONE]') continue;
        try { const p=JSON.parse(d); if(p.type==='content_block_delta'&&p.delta&&p.delta.text){txt+=p.delta.text;el.innerHTML=md(txt);} } catch(e){}
      }
    }
    el.classList.remove('blink');
  } catch(e) {
    console.error(e);
    box.innerHTML = '<div class="ai-err">è¯·æ±‚å¤±è´¥<br><button onclick="location.reload()">åˆ·æ–°é‡è¯•</button></div>';
  }
}

function md(t) { return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>'); }

init();
</script>
</body>
</html>
